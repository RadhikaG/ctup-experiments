cmake_minimum_required(VERSION 3.15)
project(deps-download NONE)

set(CMAKE_BUILD_TYPE RelWithDebInfo)
set(NPROC 2)

# Set the C++ standard
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
#set(CMAKE_CXX_COMPILER "usr/bin/g++" )
# ExternalProject is used to build and manage the dependencies
include(ExternalProject)

# Build ctup, bear helps generate compile_commands.json
ExternalProject_Add(ctup
  SOURCE_DIR ${CMAKE_SOURCE_DIR}/deps/compile-time-urdf-parser
  CONFIGURE_COMMAND ""
  BUILD_COMMAND bear make -j${NPROC}
  BUILD_IN_SOURCE true
  INSTALL_COMMAND make
)

# Build CppAD
ExternalProject_Add(CppAD
    SOURCE_DIR ${CMAKE_SOURCE_DIR}/deps/CppAD
    BINARY_DIR ${CMAKE_BINARY_DIR}/CppAD
    CMAKE_ARGS -DCMAKE_INSTALL_PREFIX=${CMAKE_BINARY_DIR}/install/CppAD -DCMAKE_EXPORT_COMPILE_COMMANDS=1 -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE}
    BUILD_COMMAND make -j${NPROC}
    INSTALL_DIR ${CMAKE_BINARY_DIR}/install/CppAD
)

include_directories(${CMAKE_BINARY_DIR}/install/CppAD/include)
link_directories(${CMAKE_BINARY_DIR}/install/CppAD/lib)

# Build CppADCodeGen, depends on CppAD
ExternalProject_Add(CppADCodeGen
    DEPENDS CppAD
    SOURCE_DIR ${CMAKE_SOURCE_DIR}/deps/CppADCodeGen
    BINARY_DIR ${CMAKE_BINARY_DIR}/CppADCodeGen
    CMAKE_ARGS -DCMAKE_INSTALL_PREFIX=${CMAKE_BINARY_DIR}/install/CppADCodeGen -DCMAKE_EXPORT_COMPILE_COMMANDS=1 -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE}
    BUILD_COMMAND make -j${NPROC}
    INSTALL_DIR ${CMAKE_BINARY_DIR}/install/CppADCodeGen
)

include_directories(${CMAKE_BINARY_DIR}/install/CppADCodeGen/include)

# Build hpp-fcl
ExternalProject_Add(hpp-fcl
    DEPENDS
    SOURCE_DIR ${CMAKE_SOURCE_DIR}/deps/hpp-fcl
    BINARY_DIR ${CMAKE_BINARY_DIR}/hpp-fcl
    GIT_SHALLOW TRUE
    GIT_PROGRESS TRUE
    CMAKE_ARGS -DCMAKE_EXPORT_COMPILE_COMMANDS=1 -DBUILD_PYTHON_INTERFACE=OFF -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE}
    CMAKE_CACHE_ARGS -DCPPAD_HOME:STRING=${CMAKE_BINARY_DIR}/install/CppAD/include -DGOOGLETEST_GIT:BOOL=ON -DCMAKE_INSTALL_PREFIX:STRING=${CMAKE_BINARY_DIR}/install/hpp-fcl 
    BUILD_COMMAND make -j${NPROC}
    INSTALL_DIR ${CMAKE_BINARY_DIR}/install/hpp-fcl
)

include_directories(${CMAKE_BINARY_DIR}/install/hpp-fcl/include)
link_directories(${CMAKE_BINARY_DIR}/install/hpp-fcl/lib)

# Build pinocchio, depends on CppAD, CppADCodeGen
ExternalProject_Add(pinocchio
    DEPENDS hpp-fcl CppAD CppADCodeGen
    SOURCE_DIR ${CMAKE_SOURCE_DIR}/deps/pinocchio
    BINARY_DIR ${CMAKE_BINARY_DIR}/pinocchio
    CMAKE_ARGS -DCMAKE_EXPORT_COMPILE_COMMANDS=1 -DBUILD_PYTHON_INTERFACE=OFF -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE} -DBUILD_WITH_COLLISION_SUPPORT=ON -DBUILD_WITH_CODEGEN_SUPPORT=ON
    -Dcppadcg_PREFIX=${CMAKE_BINARY_DIR}/install/CppADCodeGen -Dcppad_PREFIX=${CMAKE_BINARY_DIR}/install/CppAD
    #-DCMAKE_PREFIX_PATH=${CMAKE_BINARY_DIR}/install #/home/radhika/ctup_stuff/ctup-experiments/build/install/CppAD;/home/radhika/ctup_stuff/ctup-experiments/build/install/CppADCodeGen/;${CMAKE_BINARY_DIR}/install/hpp-fcl/lib/cmake/hpp-fcl
    -DCMAKE_PREFIX_PATH=${CMAKE_BINARY_DIR}/install/CppAD;${CMAKE_BINARY_DIR}/install/CppADCodeGen/;${CMAKE_BINARY_DIR}/install/hpp-fcl/
    -DCMAKE_MODULE_PATH=${CMAKE_BINARY_DIR}/install/hpp-fcl/lib/cmake/hpp-fcl
    CMAKE_CACHE_ARGS -DHPP-FCL_HOME:STRING=${CMAKE_BINARY_DIR}/install/hpp-fcl/include -DCPPAD_HOME:STRING=${CMAKE_BINARY_DIR}/install/CppAD/include -DGOOGLETEST_GIT:BOOL=ON -DCMAKE_INSTALL_PREFIX:STRING=${CMAKE_BINARY_DIR}/install/pinocchio 
    BUILD_COMMAND make
    INSTALL_DIR ${CMAKE_BINARY_DIR}/install/pinocchio
)
